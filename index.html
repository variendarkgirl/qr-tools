<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains same -->
    <!-- Add new dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="max-w-3xl mx-auto bg-[#112240] rounded-lg shadow-2xl p-6 border border-[#64ffda] mb-8">
        <!-- Add new controls in generate section -->
        <div id="generateSection" class="space-y-4">
            <div class="flex space-x-2">
                <input type="text" id="urlInput" 
                       placeholder="Enter URL or text" 
                       class="flex-1 p-3 rounded cyber-input" 
                       oninput="generateQR()">
                <button onclick="generateQR()" 
                        class="px-6 py-2 rounded cyber-button">
                    Generate
                </button>
            </div>
            
            <!-- New customization options -->
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-[#64ffda]">QR Code Color</label>
                    <input type="color" id="qrColor" value="#000000" 
                           class="w-full h-10 rounded cyber-input">
                </div>
                <div class="space-y-2">
                    <label class="text-[#64ffda]">Background Color</label>
                    <input type="color" id="bgColor" value="#ffffff" 
                           class="w-full h-10 rounded cyber-input">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-[#64ffda]">Error Correction</label>
                    <select id="errorCorrection" class="w-full p-2 rounded cyber-input">
                        <option value="L">Low (7%)</option>
                        <option value="M">Medium (15%)</option>
                        <option value="Q">Quartile (25%)</option>
                        <option value="H" selected>High (30%)</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-[#64ffda]">Add Logo</label>
                    <input type="file" id="logoUpload" accept="image/*" 
                           class="w-full p-2 rounded cyber-input">
                </div>
            </div>

            <div id="qrOutput" class="flex flex-col items-center p-4 bg-white rounded-lg relative">
                <div id="loadingSpinner" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#64ffda]"></div>
                </div>
            </div>

            <!-- New download buttons -->
            <div class="flex gap-2">
                <button onclick="downloadQR('png')" 
                        class="flex-1 py-2 px-4 rounded cyber-button">
                    <i class="fas fa-download mr-2"></i>PNG
                </button>
                <button onclick="downloadQR('svg')" 
                        class="flex-1 py-2 px-4 rounded cyber-button">
                    <i class="fas fa-download mr-2"></i>SVG
                </button>
            </div>

            <!-- QR History -->
            <div class="mt-4 border-t border-[#64ffda]/20 pt-4">
                <h3 class="text-[#64ffda] mb-2">Recent QRs</h3>
                <div id="qrHistory" class="grid grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- Enhanced scan section -->
        <div id="scanSection" class="hidden space-y-4">
            <!-- Previous scan content remains -->
            <!-- Enhanced results display -->
            <div id="parsedResult" class="p-3 whitespace-pre-line">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Enhanced QR generator with new features
        let currentQR = null;
        let qrHistory = JSON.parse(localStorage.getItem('qrHistory') || '[]');

        async function generateQR() {
            const text = document.getElementById('urlInput').value;
            if (!text) return;

            showLoading(true);
            
            const qrOutput = document.getElementById('qrOutput');
            qrOutput.innerHTML = '';
            
            const config = {
                text: text,
                width: 256,
                height: 256,
                colorDark: document.getElementById('qrColor').value,
                colorLight: document.getElementById('bgColor').value,
                correctLevel: QRCode.CorrectLevel[document.getElementById('errorCorrection').value]
            };

            currentQR = new QRCode(qrOutput, config);
            
            // Add logo if uploaded
            const logoFile = document.getElementById('logoUpload').files[0];
            if (logoFile) {
                await addLogoToQR(logoFile);
            }

            // Add to history
            addToHistory();
            showLoading(false);
            triggerConfetti();
        }

        async function addLogoToQR(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = qrOutput.querySelector('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate logo size (20% of QR size)
                        const logoSize = canvas.width * 0.2;
                        const x = (canvas.width - logoSize) / 2;
                        const y = (canvas.height - logoSize) / 2;
                        
                        ctx.drawImage(img, x, y, logoSize, logoSize);
                        resolve();
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        function downloadQR(format) {
            if (!currentQR) return;
            
            const canvas = qrOutput.querySelector('canvas');
            const filename = `qr-${Date.now()}.${format}`;
            
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL();
                link.click();
            } else if (format === 'svg') {
                // SVG conversion logic here
            }
        }

        function addToHistory() {
            const dataUrl = qrOutput.querySelector('canvas').toDataURL();
            qrHistory.unshift({
                text: document.getElementById('urlInput').value,
                timestamp: new Date().toISOString(),
                image: dataUrl
            });
            
            // Keep only last 5 items
            qrHistory = qrHistory.slice(0, 5);
            localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
            renderHistory();
        }

        function renderHistory() {
            const historyContainer = document.getElementById('qrHistory');
            historyContainer.innerHTML = qrHistory.map((item, index) => `
                <div class="relative group cursor-pointer" onclick="loadFromHistory(${index})">
                    <img src="${item.image}" class="w-full h-auto rounded border border-[#64ffda]/20">
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <i class="fas fa-redo text-[#64ffda]"></i>
                    </div>
                </div>
            `).join('');
        }

        // Enhanced QR parsing
        function handleScanSuccess(decodedText) {
            // ... previous parsing logic ...

            // Enhanced content detection
            let parsedHTML = decodedText;
            if (isURL(decodedText)) {
                parsedHTML = `<a href="${decodedText}" target="_blank" class="text-[#64ffda] hover:underline">${decodedText}</a>`;
            } else if (decodedText.startsWith('WIFI:')) {
                parsedHTML = parseWifiString(decodedText);
            } else if (decodedText.startsWith('BEGIN:VCARD')) {
                parsedHTML = parseVCard(decodedText);
            }

            document.getElementById('parsedResult').innerHTML = parsedHTML;
            triggerConfetti();
        }

        function parseVCard(vcard) {
            // Add vCard parsing logic
            return vcard.split('\n').map(line => {
                const [key, value] = line.split(':');
                return `<div class="py-1"><span class="text-[#64ffda]">${key}:</span> ${value}</div>`;
            }).join('');
        }

        // New UI functions
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }

        function triggerConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#64ffda', '#ff6b6b', '#4ecdc4']
            });
        }

        // Initialize history on load
        renderHistory();
    </script>
</body>
</html>
